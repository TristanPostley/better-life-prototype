<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session d5cdbf5c-819e-4d90-87e4-c339b22ca002 (2025-12-08 22:24Z) -->

# Fix debug controls visibility (2025-12-08 22:24Z)

_**User (2025-12-04 01:03Z)**_

Verify this issue exists and fix it:

The debug controls div no longer has the `hidden` class, making them visible by default on all pages. Debug controls should only appear on the timer page. While the routing.js code attempts to hide them on other pages (lines 86-92), they start in the wrong state, creating an inconsistent visual state at page load and potentially confusing users. @index.html:16-17 



Change their behavior so that all DEBUG controls are only visible while the "D" key is held down

---

_**Agent (model default, mode Agent)**_



---


Verifying the issue and implementing the fix. Checking the current state of the files.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: index.html</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/domains/navigation/routing.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "debug-controls|btn-debug" in "src/client" • 7 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src/client\utils\button-handlers.js` | `'btn-debug': async function(e) \{` | L111 |
| `src/client\utils\button-handlers.js` | `context: \{ module: 'button-handlers.js', function: 'btn-debug' \}` | L186 |
| `src/client\utils\button-handlers.js` | `'btn-debug-menu': async function(e) \{` | L191 |
| `src/client\utils\button-handlers.js` | `context: \{ module: 'button-handlers.js', function: 'btn-debug-menu' \},` | L201 |
| `src/client\utils\dom-elements.js` | `debug: safeGetElementById('btn-debug', validate),` | L69 |
| `src/client\utils\dom-elements.js` | `debugMenu: safeGetElementById('btn-debug-menu', validate),` | L70 |
| `src/client\utils\dom-elements.js` | `debugControls: safeGetElementById('debug-controls', false),` | L124 |


</details>
</tool-use>

---



---


Checking where keyboard handlers are set up:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/utils/button-handlers.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/app.js</summary>

</details>
</tool-use>

---



---


Fixing the issue: adding the `hidden` class to the debug controls, removing the page-based show/hide logic, and adding keyboard handlers to show them only while the "D" key is held down.


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: index.html</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -15,5 +15,5 @@
  
      &lt;!-- Debug Controls --&gt;
-     &lt;div id=&quot;debug-controls&quot;&gt;
+     &lt;div id=&quot;debug-controls&quot; class=&quot;hidden&quot;&gt;
          &lt;button id=&quot;btn-debug&quot;&gt;DEBUG&lt;/button&gt;
          &lt;button id=&quot;btn-debug-menu&quot;&gt;MENU&lt;/button&gt;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: src/client/domains/navigation/routing.js</summary>

**Chunk 1**
Lines added: undefined, lines removed: 9

```diff
@@ -88,13 +88,4 @@
          console.log(&#39;showPage: Animation completed&#39;);
      });
- 
-     // Show debug controls only on timer page
-     if (dom.debugControls) {
-         if (pageName === PAGES.TIMER) {
-             removeClass(dom.debugControls, CSS_CLASSES.HIDDEN);
-         } else {
-             addClass(dom.debugControls, CSS_CLASSES.HIDDEN);
-         }
-     }
  
      // Handle timer page reset
```

</details>

</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/utils/dom-elements.js</summary>

</details>
</tool-use>

---



---


Adding keyboard handlers to show debug controls only while the "D" key is held down:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: src/client/utils/button-handlers.js</summary>

**Chunk 1**
Lines added: 3, lines removed: undefined

```diff
@@ -267,4 +267,7 @@
          }
      }, true); // Use capture phase for early handling
+     
+     // Initialize debug controls keyboard handler
+     initDebugControlsKeyboard();
      
      console.log(&#39;Button handlers initialized via event delegation&#39;);
```

**Chunk 2**
Lines added: 35, lines removed: undefined

```diff
@@ -273,4 +276,39 @@
      return buttonHandlers;
  }
+ 
+ /**
+  * Initialize keyboard handlers for debug controls
+  * Debug controls are only visible while the &quot;D&quot; key is held down
+  * @returns {void}
+  */
+ function initDebugControlsKeyboard() {
+     const dom = getDOMElements();
+     if (!dom.debugControls) return;
+     
+     let isDKeyPressed = false;
+     
+     // Handle keydown - show debug controls when &quot;D&quot; is pressed
+     document.addEventListener(&#39;keydown&#39;, function(e) {
+         // Only handle &quot;D&quot; key (case-insensitive, but check for both)
+         if ((e.key === &#39;d&#39; || e.key === &#39;D&#39;) &amp;&amp; !isDKeyPressed) {
+             isDKeyPressed = true;
+             removeClass(dom.debugControls, CSS_CLASSES.HIDDEN);
+         }
+     });
+     
+     // Handle keyup - hide debug controls when &quot;D&quot; is released
+     document.addEventListener(&#39;keyup&#39;, function(e) {
+         if (e.key === &#39;d&#39; || e.key === &#39;D&#39;) {
+             isDKeyPressed = false;
+             addClass(dom.debugControls, CSS_CLASSES.HIDDEN);
+         }
+     });
+     
+     // Handle blur (when window loses focus) - hide debug controls
+     window.addEventListener(&#39;blur&#39;, function() {
+         isDKeyPressed = false;
+         addClass(dom.debugControls, CSS_CLASSES.HIDDEN);
+     });
+ }
  
  // Auto-initialize when DOM is ready
```

</details>

</tool-use>

---



---


Checking if `addClass` and `removeClass` are imported:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/utils/button-handlers.js</summary>

</details>
</tool-use>

---



---


`addClass` and `removeClass` are already imported. Checking for linting errors:


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 3 files</summary>
      
Lint paths:

- `index.html`
- `src/client/utils/button-handlers.js`
- `src/client/domains/navigation/routing.js`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


Verifying the changes are complete:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: index.html</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/client/utils/button-handlers.js</summary>

</details>
</tool-use>

---



---


## Changes Made

1. **Added `hidden` class to debug controls** in `index.html` (line 17)
   - Debug controls start hidden by default

2. **Removed page-based show/hide logic** in `routing.js` (lines 91-98)
   - Removed code that showed/hid debug controls based on the current page

3. **Added keyboard handlers** in `button-handlers.js`
   - Added `initDebugControlsKeyboard()` that:
     - Shows debug controls when "D" is pressed (keydown)
     - Hides debug controls when "D" is released (keyup)
     - Hides debug controls when the window loses focus (blur)
     - Uses a flag to prevent duplicate keydown events

Debug controls are now only visible while the "D" key is held down, regardless of the current page. They start hidden and remain hidden until "D" is pressed.

The implementation handles edge cases like:
- Window losing focus (blur event)
- Multiple keydown events (flag prevents duplicate toggles)
- Case-insensitive "D" key detection

All changes pass linting and are ready to use.

---

